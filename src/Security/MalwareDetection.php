<?php
/**
 * Developer: Camilo Lozano III - www.camilord.com
 *                              - github.com/camilord
 *                              - linkedin.com/in/camilord
 *
 * scammerchecknz - MalwareDetection.php
 * Username: Camilo
 * Date: 24/07/2021
 * Time: 1:53 PM
 */

namespace camilord\utilus\Security;

/**
 * Class MalwareDetection
 * @package App\Util
 */
class MalwareDetection
{
    /**
     * @param string $filename
     * @return bool
     */
    public function isMalware(string $filename): bool
    {
        if (file_exists($filename))
        {
            $content = file_get_contents($filename);

            if (
                stripos($content, 'basename') !== false &&
                stripos($content, 'preg_replace') !== false &&
                stripos($content, 'rawurldecode') !== false
            ) {
                return true;
            }

            if (
                stripos($content, 'function') !== false &&
                stripos($content, 'foreach') !== false
            ) {
                return true;
            }

            if (stripos($content, '<?php') !== false) {
                return true;
            }

            # header and trailer are taken from William Bowling's echo_vakzz.jpg
            # from their original h1 disclosure.
            # The 'cmd' variable is sandwiched in a qx## function.
            if (
                stripos($content, 'qx#') !== false &&
                preg_match("/qx\\#.*\\#/i", $content)
            ) {
                return true;
            }

            if ($this->isOtherScriptingLang($content)) {
                return true;
            }
        }

        return false;
    }

    /**
     * @param string $content
     * @return bool
     */
    private function isOtherScriptingLang(string $content)
    {
        $shebangs = [
            '#!/bin/sh',
            '#!/bin/bash',
            '#!/usr/bin/pwsh',
            '#!/usr/bin/env python3',
            '#!/bin/ruby',
            '#!/bin/'
        ];

        foreach($shebangs as $shebang) {
            if (stripos($content, $shebang) !== false) {
                return true;
            }
        }

        return false;
    }
}